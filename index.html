<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Visualize your most-used programming languages in your Github repos with Langits.</title>
  <link rel="stylesheet" href="./styles/styles.min.css">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Visualize your most-used programming languages in your Github repos with Langits." />
</head>
<body>
  <h1>Langits</h1>
  <p>Visualize your most-used programming languages in your GitHub repos.</p>
  <form id="form" action="" onsubmit="">
    <div>
      <label>
        Enter your Github username:
        <input type="text" placeholder="username"/>
      </label>
    </div>
    <div>
      <button type="submit">Submit</button>
    </div>
  </form>
  <p id="message"></p>
  <div style="width: 600px; max-width: 100%; margin: 40px auto;">
    <canvas id="langitsDonut"></canvas>
  </div>
  <div id="langitsTable"></div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="text/javascript">
    const message = document.getElementById("message");
    const form = document.getElementById("form");
    const langitsTable = document.getElementById("langitsTable");
    let langitsChart;
    
    form.addEventListener("submit", function(e) {
      e.preventDefault();
      getData(e.target[0].value);
    });

    function putDataInTable(data) {
      langitsTable.innerHTML = "";

      if(data.langs.length === 0) {
        console.log(data)
        message.innerText = "The user " + data.user + " has no repos with languages."
        return false;
      }

      message.innerText = "The user " + data.user + " has repos containing " + data.langs.length + " languages.";
      const table = document.createElement('table');
      table.setAttribute('style', 'border-collapse: collapse; margin-top: 20px;');
      const tbody = document.createElement('tbody');

      data.langs.forEach(lang => {
        const tr = document.createElement('tr');
        
          const td_color = document.createElement('td');
          td_color.setAttribute('style', 'background: '+lang.color+"; width: 30px;");
          tr.appendChild(td_color);

          const td_name = document.createElement('td');
          td_name.appendChild(document.createTextNode(lang.name));
          td_name.setAttribute('style', 'border: 1px solid black; padding: 4px 6px;');
          tr.appendChild(td_name);

          const td_percent = document.createElement('td');
          td_percent.appendChild(document.createTextNode(lang.percent + "%"));
          td_percent.setAttribute('style', 'border: 1px solid black; padding: 4px 6px;');
          tr.appendChild(td_percent);

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      langitsTable.appendChild(table);
    }
  
  
    /* ---------------- */

    const ctx = document.getElementById("langitsDonut");

    function createDiagonalPattern(color = 'black') {
      let shape = document.createElement('canvas');
      shape.width = 10;
      shape.height = 10;
      let c = shape.getContext("2d");
      c.strokeStyle = color;
      c.beginPath();
      c.moveTo(2,0);
      c.lineTo(10,8);
      c.stroke();
      c.beginPath();
      c.moveTo(0,8);
      c.lineTo(2,10);
      c.stroke();
      return c.createPattern(shape, 'repeat');
    }

    function createDonutChart(data) {
      if(typeof langitsChart === 'object') {
        langitsChart.destroy();
      }

      let labels = [];
      let percents = [];
      let bgColor = [];
      let smalls = {
        labels: [],
        percent: 0
      }

      data.langs.forEach(lang => {
        if(lang.percent >= 1) {
          labels.push(lang.name + ' ' + lang.percent + '%');
          percents.push(lang.percent);
          bgColor.push(lang.color);
        } else {
          smalls.labels.push(lang.name);
          smalls.percent += (+lang.percent);
        }
      });

      if(smalls.percent > 0) {
        labels.push('[' + smalls.labels.join(', ') + '] ' + smalls.percent + '%');
        percents.push(smalls.percent);
        bgColor.push(createDiagonalPattern('rebeccaPurple'));
      }

      const chartData = {
        labels: labels,
        datasets: [{
          label: 'GitHub Languages',
          data: percents,
          backgroundColor: bgColor,
          hoverOffset: 4
        }]
      }

      langitsChart = new Chart(ctx, {
        type: 'doughnut',
        data: chartData,
        options: {
          elements: {
            arc: {
              borderWidth: 3
            }
          }
        }
      })
    }
    
    async function getData(username) {

      fetch("/api/getLanguages", {
        method: "POST",
        body: JSON.stringify({
          username: username
        })
      })
      .then((response) => {
        // console.log(response.status)
        if (response.status >= 200 && response.status <= 299) {
          return response.json();
        } else {
          console.log('error here')
          throw Error(response.statusText);
        }
      })
      .then((jsonResponse) => {
        // console.log(JSON.stringify(jsonResponse, null, 2));
        putDataInTable(jsonResponse);
        createDonutChart(jsonResponse);
      }).catch((error) => {
        // Handle the error
        console.log(error)
        alert('Something went wrong. Try a different username.')
      });
    }


  </script>
</body>
</html>